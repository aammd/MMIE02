---
title: "Random groups with not many levels: species as random effects"
format: html
editor_options: 
  chunk_output_type: console
---

We'll use the penguin data to show how random effects can be used:

-   in place of fixed effects
-   to make predictions for new groups

```{r}

library(ggplot2)
suppressPackageStartupMessages(library(tidyverse))
library(tidybayes)
suppressPackageStartupMessages(library(rstanarm))
```

## Statistical models of Penguin bill morphology.

We'll start with a review of the Simpson's Paradox demonstration.

Let's begin with plotting the data:

```{r}
#| fig-cap: Bill depth (mm) as predicted by bill length (mm) across the entire `palmerpenguins` dataset.
penguins |> 
  ggplot(aes(x = bill_len, y = bill_dep)) + 
  geom_point() + 
  stat_smooth(method = "lm")
```

## Data preparation

```{r}
## get data ready
bill_len_centered <- with(penguins,
                          bill_len - mean(bill_len,
                                                na.rm = TRUE))
peng_dep_len_df <- penguins |> 
  tidyr::drop_na(bill_dep, bill_len) |> 
  mutate(bill_len_cen = bill_len - mean(bill_len))
```

## Model fitting

We'll fit three different models here and then compare them.

First, a model with no species in it:

```{r}
## fit model with rstanarm
normal_reg_stan <- stan_glm(
  bill_dep ~ 1 + bill_len_cen,
  data = peng_dep_len_df,
  family = gaussian(),

  # priors
  prior = normal(0, 0.5),          # slope (bill_len_cen)
  prior_intercept = normal(17, 2), # intercept
  prior_aux = exponential(0.5),    # sigma

  chains = 4,
  cores = 4,
  iter = 2000,
  refresh = 0,
  seed = 525600
)

normal_reg_stan
```

Then, one that adds species as a fixed effect:

```{r}
## fit model with rstanarm
normal_reg_spp_stan <- stan_glm(
  bill_dep ~ 1 + bill_len_cen + species,
  data = peng_dep_len_df,
  family = gaussian(),

  # priors
  prior = normal(0, 0.5),          # slope (bill_len_cen)
  prior_intercept = normal(17, 2), # intercept
  prior_aux = exponential(0.5),    # sigma

  chains = 4,
  cores = 4,
  iter = 2000,
  refresh = 0,
  seed = 525600
)

normal_reg_spp_stan
```

Finally, a random effect for species. With only three levels, this random effect will probably be exactly like the fixed effect above:

```{r}
## fit model with rstanarm
normal_reg_hier_spp_stan <- stan_glmer(
  bill_dep ~ 1 + bill_len_cen + (1|species),
  data = peng_dep_len_df,
  family = gaussian(),

  # priors
  prior = normal(0, 0.5),          # slope (bill_len_cen)
  prior_intercept = normal(17, 2), # intercept
  prior_aux = exponential(2),    # sigma

  chains = 4,
  cores = 4,
  iter = 2000,
  refresh = 1000,
  seed = 525600
)

normal_reg_hier_spp_stan
```

## Pairwise differences:

```{r}
get_variables(normal_reg_hier_spp_stan)

normal_reg_hier_spp_stan %>%
  spread_draws(b[term, spp]) |> 
  compare_levels(b, by = spp) |> 
  ggplot(aes(x = b, y = spp)) + 
  stat_halfeye()
```

## Model comparison

Try comparing all three models:

```{r}
rstanarm::loo_compare(
  loo(normal_reg_stan), 
  loo(normal_reg_spp_stan), 
  loo(normal_reg_hier_spp_stan)
)
```

Let's look at the actual coefficients involved

```{r}
get_variables(normal_reg_hier_spp_stan)

hier_avg <- normal_reg_hier_spp_stan %>%
  spread_rvars(`(Intercept)`, b[spp]) |> 
  mutate(spp_avg = `(Intercept)` + b,
         spp = str_replace(spp, "\\(Intercept\\) species:", ""),
         model = "hierarchical") |> 
  select(model, spp, spp_avg)

get_variables(normal_reg_spp_stan) 

simple_avg <- normal_reg_spp_stan |> 
  spread_rvars(`(Intercept)`, speciesChinstrap, speciesGentoo) |> 
  mutate(Adelie = `(Intercept)`,
         Chinstrap = Adelie + speciesChinstrap,
         Gentoo = Adelie + speciesGentoo) |> 
  select(Adelie, Chinstrap, Gentoo) |> 
  tidyr::pivot_longer(everything(), names_to = "spp", values_to = "spp_avg") |> 
  mutate(model = "simple", .before = "spp")

bind_rows(simple_avg, hier_avg) |> 
  ggplot(aes(x= spp, ydist = spp_avg, col = model)) + 
  stat_halfeye(position = position_dodge(width = .5))
```

## Making novel predictions

```{r}
library(modelr)

fake_penguins <- expand.grid(
  bill_len_cen = modelr::seq_range(peng_dep_len_df$bill_len_cen, n = 4),
  species = c("Hollander",levels(peng_dep_len_df$species))
)

add_predicted_rvars(fake_penguins, normal_reg_hier_spp_stan) |> 
  ggplot(aes(x = bill_len_cen, ydist = .prediction)) + 
  tidybayes::stat_lineribbon() + 
  facet_wrap(~species)


```
